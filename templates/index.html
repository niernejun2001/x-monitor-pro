<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Monitor Pro - æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a25;
            --bg-hover: #252535;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.3);
            --success: #00ff88;
            --danger: #ff4466;
            --warning: #ffaa00;
            --text-primary: #ffffff;
            --text-secondary: #8888aa;
            --border: #2a2a3a;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* èƒŒæ™¯åŠ¨ç”» */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 68, 102, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--success), var(--accent));
            animation: gradientMove 3s linear infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), var(--success));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-radius: 30px;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
            animation: pulse 2s infinite;
        }

        .status-dot.running {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ä¸»å¸ƒå±€ */
        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.1);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-header-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .card-header-icon.control { background: linear-gradient(135deg, #667eea, #764ba2); }
        .card-header-icon.target { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .card-header-icon.result { background: linear-gradient(135deg, #4facfe, #00f2fe); }

        .card-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        /* è¾“å…¥æ¡† */
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }

        input[type="text"]::placeholder,
        input[type="password"]::placeholder {
            color: var(--text-secondary);
        }

        /* æŒ‰é’® */
        button {
            cursor: pointer;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #0099cc);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00cc66);
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc0033);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 68, 102, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 68, 102, 0.4);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 8px;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* å¼€å…³ */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .switch-container:hover {
            background: var(--bg-hover);
        }

        .switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            border-radius: 26px;
            transition: 0.3s;
        }

        .switch-slider::before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .switch input:checked + .switch-slider {
            background: var(--success);
        }

        .switch input:checked + .switch-slider::before {
            transform: translateX(24px);
        }

        .switch-label {
            flex: 1;
        }

        .switch-label-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .switch-label-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* å§”æ´¾è´¦æˆ·è¾“å…¥åŒº */
        .delegated-section {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 10px;
        }

        .delegated-section label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .llm-filter-section {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }

        .llm-filter-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .llm-filter-note {
            font-size: 11px;
            color: var(--text-secondary);
            margin: -6px 0 8px 0;
        }

        .llm-result-box {
            margin-top: 10px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
            min-height: 58px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .control-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .control-tab-btn {
            flex: 1;
            min-width: 96px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .control-tab-btn:hover {
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .control-tab-btn.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.22), rgba(0, 153, 204, 0.16));
            color: var(--text-primary);
            border-color: rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 0 1px rgba(0, 212, 255, 0.18) inset;
        }

        .control-panel {
            display: none;
        }

        .control-panel.active {
            display: block;
        }

        .template-section {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .template-section:last-child {
            margin-bottom: 0;
        }

        .template-section h4 {
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .template-input {
            width: 100%;
            margin-bottom: 8px !important;
            padding: 10px 12px !important;
            border-radius: 8px !important;
            font-size: 12px !important;
        }

        .template-textarea {
            width: 100%;
            min-height: 90px;
            resize: vertical;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .template-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 16px rgba(0, 212, 255, 0.2);
        }

        .template-list {
            list-style: none;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--border);
            padding-top: 8px;
        }

        .template-list li {
            padding: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: flex-start;
        }

        .template-text {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            flex: 1;
        }

        .template-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .template-editor-actions {
            display: flex;
            gap: 8px;
        }

        .template-editor-actions button {
            flex: 1;
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            background: var(--bg-hover);
        }

        .task-info {
            flex: 1;
            overflow: hidden;
        }

        .task-url {
            font-size: 13px;
            color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .task-delete {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .task-delete:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        /* ç»“æœè¡¨æ ¼ */
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .result-count {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .result-count-num {
            background: var(--accent);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 13px;
        }

        .result-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        .result-filter {
            width: 220px;
            margin-bottom: 0 !important;
            padding: 8px 12px !important;
            font-size: 12px !important;
            border-radius: 8px !important;
        }

        .table-container {
            max-height: 450px;
            overflow-y: auto;
            padding: 15px;
        }

        .table-container.resizable {
            height: 280px;
            min-height: 220px;
            max-height: 75vh;
            resize: vertical;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 15px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        .user-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .user-link:hover {
            text-decoration: underline;
        }

        .user-info-cell {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .action-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .reply-template-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .dm-template-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .action-btn-row {
            display: flex;
            gap: 6px;
        }

        .btn-reply {
            background: linear-gradient(135deg, #ffaa00, #ff7a00);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.25);
        }

        .btn-reply:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 22px rgba(255, 170, 0, 0.35);
        }

        .btn-reply.done {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #001b0f;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .reply-state {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        .reply-state.done {
            color: var(--success);
            font-weight: 600;
        }

        .content-cell {
            max-width: 400px;
            line-height: 1.5;
        }

        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .source-badge.notify {
            background: rgba(0, 212, 255, 0.15);
            color: var(--accent);
        }

        .source-badge.tweet {
            background: rgba(0, 255, 136, 0.15);
            color: var(--success);
        }

        .row-enter {
            animation: rowSlide 0.5s ease;
        }

        @keyframes rowSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .result-header {
                align-items: flex-start;
                flex-direction: column;
                gap: 12px;
            }

            .result-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .result-filter {
                width: 100%;
            }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ›¸</div>
                <div class="logo-text">
                    <h1>X Monitor Pro</h1>
                    <span>æ™ºèƒ½è¯„è®ºç›‘æ§ç³»ç»Ÿ v11.0</span>
                </div>
            </div>
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ç³»ç»Ÿå¾…æœº</span>
            </div>
        </div>

        <!-- ä¸»å†…å®¹ -->
        <div class="main-grid">
            <!-- å·¦ä¾§é¢æ¿ -->
            <div class="left-panel">
                <!-- æ§åˆ¶ä¸é…ç½® -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-icon control">âš¡</div>
                        <h3>æ§åˆ¶ä¸é…ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div class="control-tabs">
                            <button type="button" class="control-tab-btn active" data-panel="control" onclick="switchControlPanel('control', this)">æ§åˆ¶ä¸­å¿ƒ</button>
                            <button type="button" class="control-tab-btn" data-panel="task" onclick="switchControlPanel('task', this)">ç›‘æ§ç›®æ ‡</button>
                            <button type="button" class="control-tab-btn" data-panel="template" onclick="switchControlPanel('template', this)">æ–‡æ¡ˆç®¡ç†</button>
                        </div>

                        <div class="control-panel active" id="controlPanel-control">
                            <input type="text" id="token" placeholder="ğŸ”‘ ç²˜è´´ Auth Token...">
                            <div class="btn-group">
                                <button class="btn-success" id="startBtn" onclick="toggle(true)">
                                    <span>â–¶</span> å¯åŠ¨ç›‘æ§
                                </button>
                                <button class="btn-danger" id="stopBtn" onclick="toggle(false)" disabled>
                                    <span>â¹</span> åœæ­¢
                                </button>
                            </div>
                            <button class="btn-primary btn-sm" type="button" onclick="testNotifyVoice()" style="width:100%; margin-top:10px;">
                                ğŸ”Š æµ‹è¯•é€šçŸ¥å£°éŸ³
                            </button>

                            <label class="switch-container" onclick="event.stopPropagation()">
                                <div class="switch">
                                    <input type="checkbox" id="notifCheckbox" onchange="toggleNotificationMonitoring()">
                                    <span class="switch-slider"></span>
                                </div>
                                <div class="switch-label">
                                    <div class="switch-label-title">ğŸ“¬ é€šçŸ¥ç›‘æ§</div>
                                    <div class="switch-label-desc">å®æ—¶æ‰«æé€šçŸ¥é¡µé¢ä¸­çš„@æåŠ</div>
                                </div>
                            </label>

                            <label class="switch-container" onclick="event.stopPropagation()">
                                <div class="switch">
                                    <input type="checkbox" id="headlessCheckbox" onchange="toggleHeadlessMode()" checked>
                                    <span class="switch-slider"></span>
                                </div>
                                <div class="switch-label">
                                    <div class="switch-label-title">ğŸ–¥ï¸ æ— å¤´æ¨¡å¼</div>
                                    <div class="switch-label-desc">å…³é—­åæ˜¾ç¤ºæµè§ˆå™¨çª—å£(è°ƒè¯•ç”¨)</div>
                                </div>
                            </label>

                            <div class="delegated-section">
                                <label>å§”æ´¾è´¦æˆ·ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" id="delegatedAccount" placeholder="@username" style="margin-bottom:10px;">
                                <button class="btn-primary btn-sm" onclick="saveDelegatedAccount()" style="width:100%;">
                                    ğŸ’¾ ä¿å­˜è´¦æˆ·é…ç½®
                                </button>
                            </div>

                            <div class="llm-filter-section">
                                <div class="llm-filter-title">ğŸ¤– LLM å†…å®¹è¿‡æ»¤ï¼ˆOpenAIå…¼å®¹ï¼‰</div>
                                <div class="llm-filter-note">ç”¨äºè¡¥å……è§„åˆ™è¿‡æ»¤ï¼Œè¯†åˆ«å™ªå£°è¯„è®ºä¸æ„å‘è¯„è®ºã€‚</div>

                                <label class="switch-container" onclick="event.stopPropagation()" style="margin-bottom:10px;">
                                    <div class="switch">
                                        <input type="checkbox" id="llmFilterEnabled">
                                        <span class="switch-slider"></span>
                                    </div>
                                    <div class="switch-label">
                                        <div class="switch-label-title">å¯ç”¨ LLM è¿‡æ»¤</div>
                                        <div class="switch-label-desc">è§„åˆ™æœªå‘½ä¸­æ—¶è°ƒç”¨å°æ¨¡å‹åˆ¤å®š</div>
                                    </div>
                                </label>

                                <input type="text" id="llmBaseUrl" placeholder="https://ollama-ai.shou.heiyu.space/v1">
                                <input type="text" id="llmModel" placeholder="æ¨¡å‹åï¼Œä¾‹å¦‚ qwen2.5:7b">
                                <input type="password" id="llmApiKey" placeholder="API Keyï¼ˆæ— åˆ™å¡« EMPTYï¼‰">
                                <input type="text" id="llmTimeoutSec" placeholder="è¶…æ—¶ç§’æ•°ï¼ˆ2-30ï¼‰" value="8">
                                <div class="template-editor-actions">
                                    <button class="btn-primary btn-sm" onclick="saveLlmFilterConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                    <button class="btn-ghost btn-sm" onclick="testLlmFilterModel()">ğŸ§ª æµ‹è¯•æ¨¡å‹</button>
                                </div>
                                <textarea id="llmIntentInput" class="template-textarea" placeholder="è¾“å…¥è¯„è®ºå†…å®¹è¿›è¡Œæ„å‘åˆ†æï¼Œä¾‹å¦‚ï¼š1 è¯¢ä»·"></textarea>
                                <button class="btn-primary btn-sm" onclick="analyzeCommentIntentByLlm()" style="width:100%;">
                                    ğŸ” åˆ†æè¯„è®ºæ„å‘
                                </button>
                                <div id="llmIntentResult" class="llm-result-box">ç­‰å¾…æµ‹è¯•æˆ–åˆ†æ...</div>
                            </div>
                        </div>

                        <div class="control-panel" id="controlPanel-task">
                            <input type="text" id="newUrl" placeholder="ğŸ“ ç²˜è´´æ¨æ–‡é“¾æ¥...">
                            <button class="btn-primary" onclick="addTask()" style="width:100%;">
                                <span>â•</span> æ·»åŠ ç›‘æ§
                            </button>
                            <div class="task-list" id="taskList" style="margin-top:15px;"></div>
                        </div>

                        <div class="control-panel" id="controlPanel-template">
                            <div class="template-section">
                                <h4>è¯„è®ºå›å¤æ–‡æ¡ˆ</h4>
                                <input type="text" id="replyTemplateInput" class="template-input" placeholder="è¾“å…¥è¯„è®ºå›å¤æ–‡æ¡ˆ...">
                                <div class="template-editor-actions">
                                    <button class="btn-primary btn-sm" id="replyTemplateSubmitBtn" onclick="submitTemplate('reply')">â• æ·»åŠ è¯„è®ºæ–‡æ¡ˆ</button>
                                    <button class="btn-ghost btn-sm" id="replyTemplateCancelBtn" onclick="cancelTemplateEdit('reply')" style="display:none;">å–æ¶ˆä¿®æ”¹</button>
                                </div>
                                <ul id="replyTemplateList" class="template-list"></ul>
                            </div>

                            <div class="template-section">
                                <h4>ç§ä¿¡æ–‡æ¡ˆ</h4>
                                <textarea id="dmTemplateInput" class="template-textarea" placeholder="è¾“å…¥ç§ä¿¡æ–‡æ¡ˆ..."></textarea>
                                <div class="template-editor-actions">
                                    <button class="btn-primary btn-sm" id="dmTemplateSubmitBtn" onclick="submitTemplate('dm')">â• æ·»åŠ ç§ä¿¡æ–‡æ¡ˆ</button>
                                    <button class="btn-ghost btn-sm" id="dmTemplateCancelBtn" onclick="cancelTemplateEdit('dm')" style="display:none;">å–æ¶ˆä¿®æ”¹</button>
                                </div>
                                <ul id="dmTemplateList" class="template-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panel">
                <!-- é€šçŸ¥ç»“æœ -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="result-header">
                        <div class="result-count">
                            <div class="card-header-icon" style="background: linear-gradient(135deg, #00d4ff, #0099cc);">ğŸ“¬</div>
                            <h3 style="font-size:16px;">é€šçŸ¥æ•è·</h3>
                            <span class="result-count-num" id="notifyCount">0</span>
                        </div>
                        <div class="result-actions">
                            <input type="text" id="notifyFilterInput" class="result-filter" list="notifyFilterOptions" placeholder="ç­›é€‰ @ç”¨æˆ· / å…³é”®è¯" oninput="applyResultFilter('notify')">
                            <datalist id="notifyFilterOptions"></datalist>
                            <button class="btn-ghost btn-sm" onclick="clearResults('notify')">ğŸ—‘ï¸ æ¸…ç©º</button>
                        </div>
                    </div>

                    <div class="table-container resizable">
                        <table>
                            <thead>
                                <tr>
                                    <th width="70">æ—¶é—´</th>
                                    <th width="130">ç”¨æˆ·ä¿¡æ¯</th>
                                    <th>è¯„è®ºå†…å®¹</th>
                                    <th width="330">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="notifyTableBody"></tbody>
                        </table>
                        <div class="empty-state" id="notifyEmptyState">
                            <div class="empty-state-icon">ğŸ“¬</div>
                            <div class="empty-state-text">æš‚æ— é€šçŸ¥æ•è·</div>
                        </div>
                    </div>
                </div>

                <!-- æ¨æ–‡ç»“æœ -->
                <div class="card">
                    <div class="result-header">
                        <div class="result-count">
                            <div class="card-header-icon" style="background: linear-gradient(135deg, #00ff88, #00cc66);">ğŸ’¬</div>
                            <h3 style="font-size:16px;">æ¨æ–‡æ•è·</h3>
                            <span class="result-count-num" id="tweetCount">0</span>
                        </div>
                        <div class="result-actions">
                            <input type="text" id="tweetFilterInput" class="result-filter" list="tweetFilterOptions" placeholder="ç­›é€‰ @ç”¨æˆ· / å…³é”®è¯" oninput="applyResultFilter('tweet')">
                            <datalist id="tweetFilterOptions"></datalist>
                            <button class="btn-ghost btn-sm" onclick="clearResults('tweet')">ğŸ—‘ï¸ æ¸…ç©º</button>
                            <button class="btn-ghost btn-sm" onclick="clearBlocklist()">â›” æ¸…ç©ºé»‘åå•</button>
                        </div>
                    </div>

                    <div class="table-container resizable">
                        <table>
                            <thead>
                                <tr>
                                    <th width="70">æ—¶é—´</th>
                                    <th width="110">ç”¨æˆ·</th>
                                    <th>è¯„è®ºå†…å®¹</th>
                                    <th width="90">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tweetTableBody"></tbody>
                        </table>
                        <div class="empty-state" id="tweetEmptyState">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div class="empty-state-text">æš‚æ— æ¨æ–‡æ•è·</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const tableBodyIds = { notify: 'notifyTableBody', tweet: 'tweetTableBody' };
        const filterInputIds = { notify: 'notifyFilterInput', tweet: 'tweetFilterInput' };
        const filterOptionIds = { notify: 'notifyFilterOptions', tweet: 'tweetFilterOptions' };
        let notifyReplyTemplates = [];
        let dmMessageTemplates = [];
        const templateEditState = { reply: -1, dm: -1 };
        const notifyVoiceText = 'æ¥å®¢äº†ï¼Œå¿«ç‚¹æ¥æ¥å®¢äº†';
        let lastNotifyVoiceAt = 0;
        let cachedNotifyVoice = null;
        let notifyVoicePlaying = false;
        let notifyVoiceTimer = null;
        const notifyVoiceQueue = [];

        function pickNotifyVoice() {
            if (!('speechSynthesis' in window)) return null;
            const voices = window.speechSynthesis.getVoices() || [];
            if (!voices.length) return null;

            const femaleKeys = ['female', 'woman', 'girl', 'å¥³', 'xiaoxiao', 'xiaoyi', 'xiaohan', 'xiaomo', 'tingting', 'siri'];
            const zhVoices = voices.filter(v => (v.lang || '').toLowerCase().includes('zh'));
            const scored = (zhVoices.length ? zhVoices : voices).map(v => {
                const name = `${v.name || ''} ${(v.lang || '')}`.toLowerCase();
                let score = 0;
                if ((v.lang || '').toLowerCase().includes('zh-cn')) score += 6;
                if ((v.lang || '').toLowerCase().includes('zh')) score += 3;
                if (femaleKeys.some(k => name.includes(k))) score += 8;
                if ((v.name || '').toLowerCase().includes('natural')) score += 2;
                return { v, score };
            }).sort((a, b) => b.score - a.score);
            return scored.length ? scored[0].v : null;
        }

        function preloadNotifyVoice() {
            cachedNotifyVoice = pickNotifyVoice();
        }

        function buildNotifyVoiceText(contentText='') {
            const raw = String(contentText || '').replace(/\s+/g, ' ').trim();
            if(!raw) return notifyVoiceText;
            const maxLen = 80;
            const clipped = raw.length > maxLen ? `${raw.slice(0, maxLen)}...` : raw;
            return `${notifyVoiceText}ï¼Œè¯„è®ºå†…å®¹ï¼š${clipped}`;
        }

        function _playNotifyVoiceOnce(contentText = '', done = null) {
            const speakText = buildNotifyVoiceText(contentText);

            if ('speechSynthesis' in window) {
                try {
                    const utter = new SpeechSynthesisUtterance(speakText);
                    utter.lang = 'zh-CN';
                    // åæ¸©æŸ”å¥³å£° + ç¨å¾®æ›´æœ‰æ„ŸæŸ“åŠ›
                    utter.rate = 1.08;
                    utter.pitch = 1.2;
                    utter.volume = 1.0;
                    if (!cachedNotifyVoice) cachedNotifyVoice = pickNotifyVoice();
                    if (cachedNotifyVoice) utter.voice = cachedNotifyVoice;
                    utter.onend = () => { if (typeof done === 'function') done(); };
                    utter.onerror = () => { if (typeof done === 'function') done(); };
                    window.speechSynthesis.speak(utter);
                    return;
                } catch (_) {}
            }

            // è¯­éŸ³ä¸å¯ç”¨æ—¶ï¼Œé€€åŒ–ä¸ºçŸ­æç¤ºéŸ³
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                const ctx = new AudioCtx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 880;
                gain.gain.value = 0.0001;
                osc.connect(gain);
                gain.connect(ctx.destination);
                const t = ctx.currentTime;
                gain.gain.exponentialRampToValueAtTime(0.08, t + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
                osc.start(t);
                osc.stop(t + 0.2);
            } catch (_) {}
            if (typeof done === 'function') done();
        }

        function processNotifyVoiceQueue() {
            if (notifyVoicePlaying) return;
            if (!notifyVoiceQueue.length) return;

            notifyVoicePlaying = true;
            const item = notifyVoiceQueue.shift();
            const now = Date.now();
            const gapMs = item.force ? 0 : Math.max(0, 1200 - (now - lastNotifyVoiceAt));

            if (notifyVoiceTimer) {
                clearTimeout(notifyVoiceTimer);
                notifyVoiceTimer = null;
            }

            notifyVoiceTimer = setTimeout(() => {
                _playNotifyVoiceOnce(item.contentText, () => {
                    lastNotifyVoiceAt = Date.now();
                    notifyVoicePlaying = false;
                    processNotifyVoiceQueue();
                });
            }, gapMs);
        }

        function announceNewNotifyByVoice(force = false, contentText = '') {
            const cleanText = String(contentText || '').trim();
            notifyVoiceQueue.push({ force: !!force, contentText: cleanText });
            processNotifyVoiceQueue();
        }

        function testNotifyVoice() {
            announceNewNotifyByVoice(true, 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®ºå†…å®¹');
        }

        function switchControlPanel(panelKey, btn) {
            document.querySelectorAll('.control-panel').forEach(panel => panel.classList.remove('active'));
            const targetPanel = document.getElementById(`controlPanel-${panelKey}`);
            if(targetPanel) targetPanel.classList.add('active');

            document.querySelectorAll('.control-tab-btn').forEach(tabBtn => tabBtn.classList.remove('active'));
            if(btn) {
                btn.classList.add('active');
            } else {
                const targetBtn = document.querySelector(`.control-tab-btn[data-panel="${panelKey}"]`);
                if(targetBtn) targetBtn.classList.add('active');
            }
        }

        window.onload = () => {
            preloadNotifyVoice();
            if ('speechSynthesis' in window && typeof window.speechSynthesis.onvoiceschanged !== 'undefined') {
                window.speechSynthesis.onvoiceschanged = () => preloadNotifyVoice();
            }
            switchControlPanel('control');
            fetch('/api/state').then(r=>r.json()).then(d=>{
            document.getElementById('token').value = d.token || '';
            document.getElementById('notifCheckbox').checked = d.notification_monitoring || false;
            document.getElementById('headlessCheckbox').checked = d.headless_mode !== false;
            document.getElementById('delegatedAccount').value = d.delegated_account || '';
            document.getElementById('llmFilterEnabled').checked = !!d.llm_filter_enabled;
            document.getElementById('llmBaseUrl').value = d.llm_filter_base_url || '';
            document.getElementById('llmModel').value = d.llm_filter_model || '';
            document.getElementById('llmApiKey').value = d.llm_filter_api_key || '';
            document.getElementById('llmTimeoutSec').value = d.llm_filter_timeout_sec || 8;
            syncTemplatesFromPayload(d);
            renderTasks(d.tasks);
            if(d.is_running) setStatus(true);

            if(d.pending && d.pending.length > 0) {
                d.pending.forEach(item => addRow(item, false));
            }

            refreshFilterOptions('notify');
            refreshFilterOptions('tweet');
            applyResultFilter('notify');
            applyResultFilter('tweet');
            });
        };

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escapeAttr(str) {
            return escapeHtml(str).replace(/`/g, '&#96;');
        }

        function setStatus(run) {
            document.getElementById('startBtn').disabled = run;
            document.getElementById('stopBtn').disabled = !run;
            document.getElementById('token').disabled = run;

            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if(run) {
                dot.classList.add('running');
                text.textContent = 'è¿è¡Œä¸­';
                text.style.color = 'var(--success)';
            } else {
                dot.classList.remove('running');
                text.textContent = 'å·²åœæ­¢';
                text.style.color = 'var(--danger)';
            }
        }

        function renderTasks(t) {
            const div = document.getElementById('taskList');
            if(!t || t.length === 0) {
                div.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-secondary); font-size:13px;">æš‚æ— ç›‘æ§ä»»åŠ¡</div>';
                return;
            }
            div.innerHTML = t.map(x => `
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-url">${x.url.split('status/')[1] || x.url}</div>
                        <div class="task-time">ä¸Šæ¬¡æ£€æŸ¥: ${x.last_check}</div>
                    </div>
                    <button class="task-delete" onclick="delTask('${x.url}')">âœ•</button>
                </div>`).join('');
        }

        function addTask() {
            const u = document.getElementById('newUrl').value;
            if(!u) return;
            fetch('/api/task/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url:u})})
                .then(r=>r.json()).then(d=>{ renderTasks(d.tasks); document.getElementById('newUrl').value=''; });
        }

        function delTask(u) {
            fetch('/api/task/remove', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url:u})})
                .then(r=>r.json()).then(d=>renderTasks(d.tasks));
        }

        function toggle(s) {
            const t = document.getElementById('token').value;
            if(s && !t) return alert('è¯·å…ˆè¾“å…¥ Token');
            fetch(s?'/api/start':'/api/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:t})})
                .then(r=>r.json()).then(d => { if(d.status==='ok') setStatus(s); });
        }

        function toggleNotificationMonitoring() {
            const enabled = document.getElementById('notifCheckbox').checked;
            fetch('/api/toggle_notification', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({enabled:enabled})})
                .then(r=>r.json());
        }

        function toggleHeadlessMode() {
            const enabled = document.getElementById('headlessCheckbox').checked;
            fetch('/api/toggle_headless', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({enabled:enabled})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        const modeText = enabled ? 'æ— å¤´æ¨¡å¼' : 'æœ‰å¤´æ¨¡å¼(è°ƒè¯•)';
                        if(d.auto_restarted) {
                            alert(`ğŸ–¥ï¸ å·²åˆ‡æ¢ä¸º${modeText}\nâœ… ç›‘æ§å·²è‡ªåŠ¨é‡å¯`);
                        } else {
                            alert(`ğŸ–¥ï¸ å·²åˆ‡æ¢ä¸º${modeText}`);
                        }
                    } else {
                        alert(`åˆ‡æ¢å¤±è´¥: ${d.msg || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                });
        }

        function saveDelegatedAccount() {
            const account = document.getElementById('delegatedAccount').value.trim();
            fetch('/api/set_delegated_account', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({account:account})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        alert(account ? `âœ… å·²è®¾ç½®å§”æ´¾è´¦æˆ·: ${account}` : 'âœ… å·²æ¸…é™¤å§”æ´¾è´¦æˆ·');
                    }
                });
        }

        function saveLlmFilterConfig() {
            const enabled = document.getElementById('llmFilterEnabled').checked;
            const baseUrl = document.getElementById('llmBaseUrl').value.trim();
            const model = document.getElementById('llmModel').value.trim();
            const apiKey = document.getElementById('llmApiKey').value.trim() || 'EMPTY';
            let timeoutSec = parseFloat(document.getElementById('llmTimeoutSec').value || '8');
            if(Number.isNaN(timeoutSec)) timeoutSec = 8;
            timeoutSec = Math.max(2, Math.min(30, timeoutSec));
            document.getElementById('llmTimeoutSec').value = timeoutSec;

            if(enabled && (!baseUrl || !model)) {
                alert('å¯ç”¨ LLM è¿‡æ»¤æ—¶ï¼ŒBase URL å’Œæ¨¡å‹åä¸èƒ½ä¸ºç©º');
                return;
            }

            fetch('/api/set_llm_filter_config', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    enabled: enabled,
                    base_url: baseUrl,
                    model: model,
                    api_key: apiKey,
                    timeout_sec: timeoutSec
                })
            }).then(r=>r.json()).then(d => {
                if(d.status === 'ok') {
                    alert(`âœ… LLMè¿‡æ»¤é…ç½®å·²ä¿å­˜${enabled ? 'å¹¶å¯ç”¨' : 'ï¼ˆå½“å‰ç¦ç”¨ï¼‰'}`);
                } else {
                    alert(`ä¿å­˜å¤±è´¥: ${d.msg || 'æœªçŸ¥é”™è¯¯'}`);
                }
            }).catch(() => {
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œä¿å­˜å¤±è´¥');
            });
        }

        function collectLlmRuntimePayload() {
            let timeoutSec = parseFloat(document.getElementById('llmTimeoutSec').value || '8');
            if(Number.isNaN(timeoutSec)) timeoutSec = 8;
            timeoutSec = Math.max(2, Math.min(30, timeoutSec));
            document.getElementById('llmTimeoutSec').value = timeoutSec;
            return {
                base_url: document.getElementById('llmBaseUrl').value.trim(),
                model: document.getElementById('llmModel').value.trim(),
                api_key: (document.getElementById('llmApiKey').value || '').trim() || 'EMPTY',
                timeout_sec: timeoutSec
            };
        }

        function setLlmIntentResult(text, isError=false) {
            const box = document.getElementById('llmIntentResult');
            if(!box) return;
            box.style.color = isError ? 'var(--danger)' : 'var(--text-secondary)';
            box.textContent = String(text || '');
        }

        function testLlmFilterModel() {
            const payload = collectLlmRuntimePayload();
            if(!payload.base_url || !payload.model) {
                setLlmIntentResult('è¯·å…ˆå¡«å†™ Base URL å’Œæ¨¡å‹å', true);
                return;
            }
            setLlmIntentResult('æ­£åœ¨æµ‹è¯•æ¨¡å‹è¿é€šæ€§...');
            fetch('/api/llm_filter/test', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(d => {
                if(d.status === 'ok') {
                    const msg = [
                        `æ¨¡å‹å¯ç”¨: ${d.model || '-'}`,
                        `å»¶è¿Ÿ: ${d.latency_ms || 0}ms`,
                        `æ¥å£: ${d.endpoint || '-'}`,
                    ].join('\n');
                    setLlmIntentResult(msg, false);
                } else {
                    setLlmIntentResult(`æµ‹è¯•å¤±è´¥: ${d.msg || 'æœªçŸ¥é”™è¯¯'}`, true);
                }
            }).catch(() => {
                setLlmIntentResult('ç½‘ç»œå¼‚å¸¸ï¼Œæ¨¡å‹æµ‹è¯•å¤±è´¥', true);
            });
        }

        function analyzeCommentIntentByLlm() {
            const payload = collectLlmRuntimePayload();
            const content = (document.getElementById('llmIntentInput').value || '').trim();
            if(!content) {
                setLlmIntentResult('è¯·è¾“å…¥è¦åˆ†æçš„è¯„è®ºå†…å®¹', true);
                return;
            }
            setLlmIntentResult('æ­£åœ¨åˆ†æè¯„è®ºæ„å‘...');
            fetch('/api/llm_filter/analyze', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({...payload, content})
            }).then(r => r.json()).then(d => {
                if(d.status !== 'ok') {
                    setLlmIntentResult(`åˆ†æå¤±è´¥: ${d.msg || 'æœªçŸ¥é”™è¯¯'}`, true);
                    return;
                }
                const a = d.analysis || {};
                const signals = Array.isArray(a.signals) ? a.signals.join(', ') : '';
                const lines = [
                    `æ„å‘ç­‰çº§: ${a.intent_level || '-'} (${a.intent_score ?? 0}åˆ†)`,
                    `æ˜¯å¦æ„å‘ç”¨æˆ·: ${a.is_intent_user ? 'æ˜¯' : 'å¦'}`,
                    `è§„åˆ™åˆ†: ${a.rule_score ?? '-'} | LLMåˆ†: ${a.llm_score ?? '-'}`,
                    `è¯†åˆ«ä¿¡å·: ${signals || '-'}`,
                    `åˆ¤å®šä¾æ®: ${a.reason || '-'}`,
                ];
                if(a.llm_error) {
                    lines.push(`LLMå¼‚å¸¸: ${a.llm_error}`);
                }
                setLlmIntentResult(lines.join('\n'), false);
            }).catch(() => {
                setLlmIntentResult('ç½‘ç»œå¼‚å¸¸ï¼Œè¯„è®ºåˆ†æå¤±è´¥', true);
            });
        }

        function getTemplateArray(type) {
            return type === 'reply' ? notifyReplyTemplates : dmMessageTemplates;
        }

        function getTemplateTypeName(type) {
            return type === 'reply' ? 'è¯„è®ºå›å¤' : 'ç§ä¿¡';
        }

        function getTemplateInput(type) {
            return document.getElementById(type === 'reply' ? 'replyTemplateInput' : 'dmTemplateInput');
        }

        function getTemplateSubmitBtn(type) {
            return document.getElementById(type === 'reply' ? 'replyTemplateSubmitBtn' : 'dmTemplateSubmitBtn');
        }

        function getTemplateCancelBtn(type) {
            return document.getElementById(type === 'reply' ? 'replyTemplateCancelBtn' : 'dmTemplateCancelBtn');
        }

        function applyTemplateEditUi(type) {
            const isEdit = templateEditState[type] >= 0;
            const submitBtn = getTemplateSubmitBtn(type);
            const cancelBtn = getTemplateCancelBtn(type);
            if(submitBtn) {
                submitBtn.textContent = isEdit
                    ? 'ğŸ’¾ ä¿å­˜ä¿®æ”¹'
                    : (type === 'reply' ? 'â• æ·»åŠ è¯„è®ºæ–‡æ¡ˆ' : 'â• æ·»åŠ ç§ä¿¡æ–‡æ¡ˆ');
            }
            if(cancelBtn) {
                cancelBtn.style.display = isEdit ? 'inline-flex' : 'none';
            }
        }

        function startTemplateEdit(type, index, content) {
            templateEditState[type] = index;
            const input = getTemplateInput(type);
            if(input) {
                input.value = content || '';
                input.focus();
                try {
                    if(typeof input.setSelectionRange === 'function') {
                        input.setSelectionRange(input.value.length, input.value.length);
                    }
                } catch (_) {}
            }
            applyTemplateEditUi(type);
        }

        function cancelTemplateEdit(type) {
            templateEditState[type] = -1;
            const input = getTemplateInput(type);
            if(input) input.value = '';
            applyTemplateEditUi(type);
        }

        function syncTemplatesFromPayload(payload) {
            notifyReplyTemplates = Array.isArray(payload.notify_reply_templates) ? payload.notify_reply_templates.slice() : [];
            dmMessageTemplates = Array.isArray(payload.dm_message_templates) ? payload.dm_message_templates.slice() : [];
            if(templateEditState.reply >= notifyReplyTemplates.length) templateEditState.reply = -1;
            if(templateEditState.dm >= dmMessageTemplates.length) templateEditState.dm = -1;
            renderTemplateManager();
        }

        function renderTemplateManager() {
            renderTemplateList('reply', 'replyTemplateList');
            renderTemplateList('dm', 'dmTemplateList');
            applyTemplateEditUi('reply');
            applyTemplateEditUi('dm');
            refreshNotifyTemplateSelects();
        }

        function renderTemplateList(type, listId) {
            const list = document.getElementById(listId);
            const templates = getTemplateArray(type);
            if(!list) return;
            if(!templates.length) {
                list.innerHTML = '<li><div class="template-text" style="color:var(--text-secondary);">æš‚æ— æ¨¡æ¿</div></li>';
                return;
            }
            list.innerHTML = templates.map((tpl, idx) => `
                <li>
                    <div class="template-text">${escapeHtml(tpl)}</div>
                    <div class="template-actions">
                        <button class="btn-ghost btn-sm" onclick="editTemplate('${type}', ${idx})">âœï¸ ä¿®æ”¹</button>
                        <button class="btn-danger btn-sm" onclick="deleteTemplate('${type}', ${idx})">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </li>
            `).join('');
        }

        function handleTemplateApiResponse(d, failPrefix) {
            if(!d || d.status !== 'ok') {
                alert(`${failPrefix}: ${(d && d.msg) ? d.msg : 'æœªçŸ¥é”™è¯¯'}`);
                return false;
            }
            syncTemplatesFromPayload(d);
            return true;
        }

        function submitTemplate(type) {
            const input = getTemplateInput(type);
            if(!input) return;
            const content = (input.value || '').trim();
            if(!content) {
                alert(`è¯·è¾“å…¥${getTemplateTypeName(type)}æ–‡æ¡ˆ`);
                return;
            }

            const editingIndex = templateEditState[type];
            if(editingIndex >= 0) {
                fetch('/api/template/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type, index: editingIndex, content})
                }).then(r => r.json()).then(d => {
                    if(handleTemplateApiResponse(d, 'ä¿®æ”¹æ¨¡æ¿å¤±è´¥')) {
                        cancelTemplateEdit(type);
                    }
                }).catch(() => {
                    alert('ç½‘ç»œå¼‚å¸¸ï¼Œä¿®æ”¹æ¨¡æ¿å¤±è´¥');
                });
                return;
            }

            fetch('/api/template/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type, content})
            }).then(r => r.json()).then(d => {
                if(handleTemplateApiResponse(d, 'æ·»åŠ æ¨¡æ¿å¤±è´¥')) {
                    input.value = '';
                    applyTemplateEditUi(type);
                }
            }).catch(() => {
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œæ·»åŠ æ¨¡æ¿å¤±è´¥');
            });
        }

        function editTemplate(type, index) {
            const templates = getTemplateArray(type);
            if(index < 0 || index >= templates.length) return;
            startTemplateEdit(type, index, templates[index]);
        }

        function deleteTemplate(type, index) {
            const templates = getTemplateArray(type);
            if(index < 0 || index >= templates.length) return;
            if(!confirm(`ç¡®å®šåˆ é™¤è¿™æ¡${getTemplateTypeName(type)}æ–‡æ¡ˆå—ï¼Ÿ`)) return;
            fetch('/api/template/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type, index})
            }).then(r => r.json()).then(d => {
                if(handleTemplateApiResponse(d, 'åˆ é™¤æ¨¡æ¿å¤±è´¥')) {
                    cancelTemplateEdit(type);
                }
            }).catch(() => {
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œåˆ é™¤æ¨¡æ¿å¤±è´¥');
            });
        }

        function buildTemplateOptionHtml(templates) {
            return templates.map(t => {
                const optionValue = escapeAttr(t);
                const optionText = escapeHtml(String(t).replace(/\s+/g, ' ').trim());
                return `<option value="${optionValue}">${optionText}</option>`;
            }).join('');
        }

        function updateSelectOptions(select, templates, placeholderText) {
            if(!select) return;
            const selectedValue = select.value || '';
            const optionsHtml = buildTemplateOptionHtml(templates);
            select.innerHTML = `<option value="">${escapeHtml(placeholderText)}</option>${optionsHtml}`;
            if(selectedValue && templates.includes(selectedValue)) {
                select.value = selectedValue;
            }
        }

        function refreshNotifyTemplateSelects() {
            const rows = getTableRows('notify');
            rows.forEach(row => {
                updateSelectOptions(row.querySelector('.reply-template-select'), notifyReplyTemplates, 'é€‰æ‹©å›å¤å†…å®¹...');
                updateSelectOptions(row.querySelector('.dm-template-select'), dmMessageTemplates, 'é€‰æ‹©ç§ä¿¡å†…å®¹...');
            });
        }

        function markDone(key, btn) {
            const row = btn.closest('tr');
            const handle = row ? (row.getAttribute('data-handle') || '') : '';
            if(row) row.style.opacity = '0.3';

            fetch('/api/mark_done', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({key:key, handle:handle})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        setTimeout(() => {
                            if(row) row.remove();
                            refreshFilterOptions('notify');
                            refreshFilterOptions('tweet');
                            updateResultCount();
                        }, 300);
                    }
                });
        }

        let suppressExternalLinkUntil = 0;

        function markActionClick(evt) {
            if(evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }
            suppressExternalLinkUntil = Date.now() + 1200;
        }

        function handleUserLinkClick(evt) {
            if(Date.now() < suppressExternalLinkUntil) {
                if(evt) {
                    evt.preventDefault();
                    evt.stopPropagation();
                }
                return false;
            }
            return true;
        }

        function markDoneFromButton(evt, btn) {
            markActionClick(evt);
            const row = btn.closest('tr');
            const key = row ? (row.getAttribute('data-key') || '') : '';
            if(!key) return;
            markDone(key, btn);
        }

        function isNotifyItemReplied(item) {
            return !!(item && (item.notify_replied || item.reply_checked));
        }

        function applyNotifyReplyState(row, replied, replyTime='') {
            if(!row) return;
            row.setAttribute('data-notify-replied', replied ? '1' : '0');

            const replyBtn = row.querySelector('.btn-reply');
            const replyState = row.querySelector('.reply-state');
            const replySelect = row.querySelector('.reply-template-select');
            const dmSelect = row.querySelector('.dm-template-select');

            if(replyBtn) {
                replyBtn.disabled = false;
                replyBtn.textContent = replied ? 'â†© å†æ¬¡å›å¤' : 'â†© å›å¤';
                replyBtn.classList.remove('done');
            }
            if(replySelect) replySelect.disabled = false;
            if(dmSelect) dmSelect.disabled = false;

            if(replyState) {
                if(replied) {
                    const suffix = replyTime ? ` (${replyTime})` : '';
                    replyState.textContent = `å·²å›å¤${suffix}`;
                    replyState.classList.add('done');
                } else {
                    replyState.textContent = 'æœªå›å¤';
                    replyState.classList.remove('done');
                }
            }
        }

        function sendNotifyReply(evt, btn) {
            markActionClick(evt);
            const row = btn.closest('tr');
            const key = row ? (row.getAttribute('data-key') || '') : '';
            const handle = row ? (row.getAttribute('data-handle') || '') : '';
            const replySelect = row ? row.querySelector('.reply-template-select') : null;
            const dmSelect = row ? row.querySelector('.dm-template-select') : null;
            const message = replySelect ? (replySelect.value || '').trim() : '';
            const dmMessage = dmSelect ? (dmSelect.value || '').trim() : '';
            if(!key || !message) {
                alert('è¯·å…ˆé€‰æ‹©å›å¤å†…å®¹');
                return;
            }
            if(!dmMessage) {
                alert('è¯·å…ˆé€‰æ‹©ç§ä¿¡å†…å®¹');
                return;
            }

            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = 'å‘é€ä¸­...';

            fetch('/api/notify_reply', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({key:key, message:message, dm_message:dmMessage})
            }).then(r=>r.json()).then(d => {
                if(d.status === 'ok') {
                    const replyTime = (d.reply_time || '').trim();
                    applyNotifyReplyState(row, true, replyTime);
                    alert(`âœ… å·²å›å¤ ${handle || ''}`);
                } else {
                    alert(`å›å¤å¤±è´¥: ${d.msg || 'æœªçŸ¥é”™è¯¯'}`);
                }
            }).catch(() => {
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œå›å¤å¤±è´¥');
            }).finally(() => {
                btn.disabled = false;
                const repliedNow = row ? (row.getAttribute('data-notify-replied') === '1') : false;
                btn.textContent = repliedNow ? 'â†© å†æ¬¡å›å¤' : oldText;
            });
        }

        function clearResults(type) {
            const typeText = type === 'notify' ? 'é€šçŸ¥' : 'æ¨æ–‡';
            if(!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${typeText}æ•è·ç»“æœå—ï¼Ÿ`)) return;
            fetch('/api/clear_results', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type: type})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        if(type === 'notify') {
                            document.getElementById('notifyTableBody').innerHTML = '';
                        } else {
                            document.getElementById('tweetTableBody').innerHTML = '';
                        }
                        refreshFilterOptions(type);
                        applyResultFilter(type);
                    }
                });
        }

        function clearBlocklist() {
            if(!confirm('ç¡®å®šè¦æ¸…ç©ºé»‘åå•å—ï¼Ÿ')) return;
            fetch('/api/clear_blocklist', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        alert('âœ… å·²æ¸…ç©ºé»‘åå•');
                    }
                });
        }

        function getTableRows(type) {
            return Array.from(document.getElementById(tableBodyIds[type]).children);
        }

        function refreshFilterOptions(type) {
            const datalist = document.getElementById(filterOptionIds[type]);
            const input = document.getElementById(filterInputIds[type]);
            if(!datalist || !input) return;

            const values = new Set();
            getTableRows(type).forEach(row => {
                const handle = (row.getAttribute('data-handle') || '').trim();
                if(handle) values.add(handle);
            });
            if(input.value.trim()) values.add(input.value.trim());

            datalist.innerHTML = '';
            Array.from(values).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN')).forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                datalist.appendChild(option);
            });
        }

        function applyResultFilter(type) {
            const input = document.getElementById(filterInputIds[type]);
            if(!input) return;

            const query = input.value.trim().toLowerCase();
            getTableRows(type).forEach(row => {
                const handle = (row.getAttribute('data-handle') || '').toLowerCase();
                const content = (row.querySelector('.content-cell')?.textContent || '').toLowerCase();
                const matched = !query || handle.includes(query) || content.includes(query);
                row.style.display = matched ? '' : 'none';
            });
            updateResultCount();
        }

        function updateResultCount() {
            const notifyRows = getTableRows('notify');
            const tweetRows = getTableRows('tweet');
            const notifyVisibleCount = notifyRows.filter(row => row.style.display !== 'none').length;
            const tweetVisibleCount = tweetRows.filter(row => row.style.display !== 'none').length;
            const notifyFilterActive = document.getElementById(filterInputIds.notify).value.trim() !== '';
            const tweetFilterActive = document.getElementById(filterInputIds.tweet).value.trim() !== '';

            document.getElementById('notifyCount').textContent = notifyFilterActive ? `${notifyVisibleCount}/${notifyRows.length}` : `${notifyRows.length}`;
            document.getElementById('tweetCount').textContent = tweetFilterActive ? `${tweetVisibleCount}/${tweetRows.length}` : `${tweetRows.length}`;
            document.getElementById('notifyEmptyState').style.display = notifyVisibleCount > 0 ? 'none' : 'block';
            document.getElementById('tweetEmptyState').style.display = tweetVisibleCount > 0 ? 'none' : 'block';
        }

        function addRow(i, animate=true) {
            if(document.querySelector(`tr[data-key="${i.key}"]`)) return false;

            const tr = document.createElement('tr');
            if(animate) tr.className = 'row-enter';
            tr.setAttribute('data-handle', i.handle);
            tr.setAttribute('data-key', i.key);

            const isNotify = i.source === 'é€šçŸ¥é¡µé¢';
            const isReplied = isNotifyItemReplied(i);
            const safeHandle = escapeHtml(i.handle || '');
            const handlePath = escapeAttr((i.handle || '').replace('@', ''));
            const userCellHtml = isNotify
                ? `<div class="user-info-cell">
                        <a class="user-link" href="https://x.com/${handlePath}/with_replies" target="_blank" onclick="return handleUserLinkClick(event)">${safeHandle}</a>
                   </div>`
                : `<a class="user-link" href="https://x.com/${handlePath}/with_replies" target="_blank" onclick="return handleUserLinkClick(event)">${safeHandle}</a>`;
            const replyOptions = buildTemplateOptionHtml(notifyReplyTemplates);
            const dmOptions = buildTemplateOptionHtml(dmMessageTemplates);
            const replyTime = escapeHtml(i.notify_reply_time || i.reply_time || '');
            const replyStateText = isReplied ? `å·²å›å¤${replyTime ? ` (${replyTime})` : ''}` : 'æœªå›å¤';
            const replyStateClass = isReplied ? 'reply-state done' : 'reply-state';
            const actionHtml = isNotify
                ? `<div class="action-stack">
                        <div class="${replyStateClass}">${replyStateText}</div>
                        <select class="reply-template-select">
                            <option value="">é€‰æ‹©å›å¤å†…å®¹...</option>
                            ${replyOptions}
                        </select>
                        <select class="dm-template-select">
                            <option value="">é€‰æ‹©ç§ä¿¡å†…å®¹...</option>
                            ${dmOptions}
                        </select>
                        <div class="action-btn-row">
                            <button type="button" class="btn-reply btn-sm" onclick="sendNotifyReply(event, this)">${isReplied ? 'â†© å†æ¬¡å›å¤' : 'â†© å›å¤'}</button>
                            <button type="button" class="btn-primary btn-sm" onclick="markDoneFromButton(event, this)">âœ… å·²å¤„ç†</button>
                        </div>
                   </div>`
                : `<button type="button" class="btn-primary btn-sm" onclick="markDoneFromButton(event, this)">âœ… å·²å¤„ç†</button>`;

            tr.innerHTML = `
                <td style="color:var(--text-secondary)">${escapeHtml(i.time || '')}</td>
                <td>${userCellHtml}</td>
                <td class="content-cell">${escapeHtml(i.content || '')}</td>
                <td>${actionHtml}</td>
            `;

            if(isNotify) {
                document.getElementById('notifyTableBody').prepend(tr);
                const replySelect = tr.querySelector('.reply-template-select');
                const dmSelect = tr.querySelector('.dm-template-select');
                const savedReplyText = (i.notify_reply_text || i.reply_text || '').trim();
                const savedDmText = (i.notify_dm_text || '').trim();
                if(replySelect && savedReplyText) replySelect.value = savedReplyText;
                if(dmSelect && savedDmText) dmSelect.value = savedDmText;
                applyNotifyReplyState(tr, isReplied, i.notify_reply_time || i.reply_time || '');
            } else {
                document.getElementById('tweetTableBody').prepend(tr);
            }
            const type = isNotify ? 'notify' : 'tweet';
            refreshFilterOptions(type);
            applyResultFilter(type);
            return true;
        }

        setInterval(() => {
            fetch('/api/updates').then(r=>r.json()).then(d => {
                const notifyContents = [];
                d.new_items.forEach(i => {
                    addRow(i, true);
                    if(i && i.source === 'é€šçŸ¥é¡µé¢') {
                        notifyContents.push(String(i.content || '').trim());
                    }
                });
                if(notifyContents.length > 0) {
                    notifyContents.forEach(content => announceNewNotifyByVoice(false, content));
                }
                if(d.tasks) renderTasks(d.tasks);
            });
        }, 1000);
    </script>
</body>
</html>

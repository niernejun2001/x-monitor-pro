<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Monitor Pro - æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a25;
            --bg-hover: #252535;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.3);
            --success: #00ff88;
            --danger: #ff4466;
            --warning: #ffaa00;
            --text-primary: #ffffff;
            --text-secondary: #8888aa;
            --border: #2a2a3a;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* èƒŒæ™¯åŠ¨ç”» */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 68, 102, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--success), var(--accent));
            animation: gradientMove 3s linear infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), var(--success));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-radius: 30px;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
            animation: pulse 2s infinite;
        }

        .status-dot.running {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ä¸»å¸ƒå±€ */
        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.1);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-header-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .card-header-icon.control { background: linear-gradient(135deg, #667eea, #764ba2); }
        .card-header-icon.target { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .card-header-icon.result { background: linear-gradient(135deg, #4facfe, #00f2fe); }

        .card-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        /* è¾“å…¥æ¡† */
        input[type="text"] {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }

        input[type="text"]::placeholder {
            color: var(--text-secondary);
        }

        /* æŒ‰é’® */
        button {
            cursor: pointer;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #0099cc);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00cc66);
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc0033);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 68, 102, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 68, 102, 0.4);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 8px;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* å¼€å…³ */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .switch-container:hover {
            background: var(--bg-hover);
        }

        .switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            border-radius: 26px;
            transition: 0.3s;
        }

        .switch-slider::before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .switch input:checked + .switch-slider {
            background: var(--success);
        }

        .switch input:checked + .switch-slider::before {
            transform: translateX(24px);
        }

        .switch-label {
            flex: 1;
        }

        .switch-label-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .switch-label-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* å§”æ´¾è´¦æˆ·è¾“å…¥åŒº */
        .delegated-section {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 10px;
        }

        .delegated-section label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .template-manager {
            margin-top: 20px;
        }

        .template-section {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .template-section:last-child {
            margin-bottom: 0;
        }

        .template-section h4 {
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .template-input {
            width: 100%;
            margin-bottom: 8px !important;
            padding: 10px 12px !important;
            border-radius: 8px !important;
            font-size: 12px !important;
        }

        .template-textarea {
            width: 100%;
            min-height: 90px;
            resize: vertical;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .template-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 16px rgba(0, 212, 255, 0.2);
        }

        .template-list {
            list-style: none;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid var(--border);
            padding-top: 8px;
        }

        .template-list li {
            padding: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: flex-start;
        }

        .template-text {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            flex: 1;
        }

        .template-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .template-editor-actions {
            display: flex;
            gap: 8px;
        }

        .template-editor-actions button {
            flex: 1;
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            background: var(--bg-hover);
        }

        .task-info {
            flex: 1;
            overflow: hidden;
        }

        .task-url {
            font-size: 13px;
            color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .task-delete {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .task-delete:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        /* ç»“æœè¡¨æ ¼ */
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .result-count {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .result-count-num {
            background: var(--accent);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 13px;
        }

        .result-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        .result-filter {
            width: 220px;
            margin-bottom: 0 !important;
            padding: 8px 12px !important;
            font-size: 12px !important;
            border-radius: 8px !important;
        }

        .table-container {
            max-height: 450px;
            overflow-y: auto;
            padding: 15px;
        }

        .table-container.resizable {
            height: 280px;
            min-height: 220px;
            max-height: 75vh;
            resize: vertical;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 15px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        .user-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .user-link:hover {
            text-decoration: underline;
        }

        .user-info-cell {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .action-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .reply-template-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .dm-template-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .action-btn-row {
            display: flex;
            gap: 6px;
        }

        .btn-reply {
            background: linear-gradient(135deg, #ffaa00, #ff7a00);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.25);
        }

        .btn-reply:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 22px rgba(255, 170, 0, 0.35);
        }

        .content-cell {
            max-width: 400px;
            line-height: 1.5;
        }

        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .source-badge.notify {
            background: rgba(0, 212, 255, 0.15);
            color: var(--accent);
        }

        .source-badge.tweet {
            background: rgba(0, 255, 136, 0.15);
            color: var(--success);
        }

        .row-enter {
            animation: rowSlide 0.5s ease;
        }

        @keyframes rowSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .result-header {
                align-items: flex-start;
                flex-direction: column;
                gap: 12px;
            }

            .result-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .result-filter {
                width: 100%;
            }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ›¸</div>
                <div class="logo-text">
                    <h1>X Monitor Pro</h1>
                    <span>æ™ºèƒ½è¯„è®ºç›‘æ§ç³»ç»Ÿ v11.0</span>
                </div>
            </div>
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ç³»ç»Ÿå¾…æœº</span>
            </div>
        </div>

        <!-- ä¸»å†…å®¹ -->
        <div class="main-grid">
            <!-- å·¦ä¾§é¢æ¿ -->
            <div class="left-panel">
                <!-- æ§åˆ¶å° -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-icon control">âš¡</div>
                        <h3>æ§åˆ¶ä¸­å¿ƒ</h3>
                    </div>
                    <div class="card-body">
                        <input type="text" id="token" placeholder="ğŸ”‘ ç²˜è´´ Auth Token...">
                        <div class="btn-group">
                            <button class="btn-success" id="startBtn" onclick="toggle(true)">
                                <span>â–¶</span> å¯åŠ¨ç›‘æ§
                            </button>
                            <button class="btn-danger" id="stopBtn" onclick="toggle(false)" disabled>
                                <span>â¹</span> åœæ­¢
                            </button>
                        </div>

                        <label class="switch-container" onclick="event.stopPropagation()">
                            <div class="switch">
                                <input type="checkbox" id="notifCheckbox" onchange="toggleNotificationMonitoring()">
                                <span class="switch-slider"></span>
                            </div>
                            <div class="switch-label">
                                <div class="switch-label-title">ğŸ“¬ é€šçŸ¥ç›‘æ§</div>
                                <div class="switch-label-desc">å®æ—¶æ‰«æé€šçŸ¥é¡µé¢ä¸­çš„@æåŠ</div>
                            </div>
                        </label>

                        <label class="switch-container" onclick="event.stopPropagation()">
                            <div class="switch">
                                <input type="checkbox" id="headlessCheckbox" onchange="toggleHeadlessMode()" checked>
                                <span class="switch-slider"></span>
                            </div>
                            <div class="switch-label">
                                <div class="switch-label-title">ğŸ–¥ï¸ æ— å¤´æ¨¡å¼</div>
                                <div class="switch-label-desc">å…³é—­åæ˜¾ç¤ºæµè§ˆå™¨çª—å£(è°ƒè¯•ç”¨)</div>
                            </div>
                        </label>

                        <div class="delegated-section">
                            <label>å§”æ´¾è´¦æˆ·ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="delegatedAccount" placeholder="@username" style="margin-bottom:10px;">
                            <button class="btn-primary btn-sm" onclick="saveDelegatedAccount()" style="width:100%;">
                                ğŸ’¾ ä¿å­˜è´¦æˆ·é…ç½®
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç›‘æ§ç›®æ ‡ -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header">
                        <div class="card-header-icon target">ğŸ¯</div>
                        <h3>ç›‘æ§ç›®æ ‡</h3>
                    </div>
                    <div class="card-body">
                        <input type="text" id="newUrl" placeholder="ğŸ“ ç²˜è´´æ¨æ–‡é“¾æ¥...">
                        <button class="btn-primary" onclick="addTask()" style="width:100%;">
                            <span>â•</span> æ·»åŠ ç›‘æ§
                        </button>
                        <div class="task-list" id="taskList" style="margin-top:15px;"></div>
                    </div>
                </div>

                <div class="card template-manager">
                    <div class="card-header">
                        <div class="card-header-icon result">ğŸ§©</div>
                        <h3>æ–‡æ¡ˆç®¡ç†</h3>
                    </div>
                    <div class="card-body">
                        <div class="template-section">
                            <h4>è¯„è®ºå›å¤æ–‡æ¡ˆ</h4>
                            <input type="text" id="replyTemplateInput" class="template-input" placeholder="è¾“å…¥è¯„è®ºå›å¤æ–‡æ¡ˆ...">
                            <div class="template-editor-actions">
                                <button class="btn-primary btn-sm" id="replyTemplateSubmitBtn" onclick="submitTemplate('reply')">â• æ·»åŠ è¯„è®ºæ–‡æ¡ˆ</button>
                                <button class="btn-ghost btn-sm" id="replyTemplateCancelBtn" onclick="cancelTemplateEdit('reply')" style="display:none;">å–æ¶ˆä¿®æ”¹</button>
                            </div>
                            <ul id="replyTemplateList" class="template-list"></ul>
                        </div>

                        <div class="template-section">
                            <h4>ç§ä¿¡æ–‡æ¡ˆ</h4>
                            <textarea id="dmTemplateInput" class="template-textarea" placeholder="è¾“å…¥ç§ä¿¡æ–‡æ¡ˆ..."></textarea>
                            <div class="template-editor-actions">
                                <button class="btn-primary btn-sm" id="dmTemplateSubmitBtn" onclick="submitTemplate('dm')">â• æ·»åŠ ç§ä¿¡æ–‡æ¡ˆ</button>
                                <button class="btn-ghost btn-sm" id="dmTemplateCancelBtn" onclick="cancelTemplateEdit('dm')" style="display:none;">å–æ¶ˆä¿®æ”¹</button>
                            </div>
                            <ul id="dmTemplateList" class="template-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="right-panel">
                <!-- é€šçŸ¥ç»“æœ -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="result-header">
                        <div class="result-count">
                            <div class="card-header-icon" style="background: linear-gradient(135deg, #00d4ff, #0099cc);">ğŸ“¬</div>
                            <h3 style="font-size:16px;">é€šçŸ¥æ•è·</h3>
                            <span class="result-count-num" id="notifyCount">0</span>
                        </div>
                        <div class="result-actions">
                            <input type="text" id="notifyFilterInput" class="result-filter" list="notifyFilterOptions" placeholder="ç­›é€‰ @ç”¨æˆ· / å…³é”®è¯" oninput="applyResultFilter('notify')">
                            <datalist id="notifyFilterOptions"></datalist>
                            <button class="btn-ghost btn-sm" onclick="clearResults('notify')">ğŸ—‘ï¸ æ¸…ç©º</button>
                        </div>
                    </div>

                    <div class="table-container resizable">
                        <table>
                            <thead>
                                <tr>
                                    <th width="70">æ—¶é—´</th>
                                    <th width="130">ç”¨æˆ·ä¿¡æ¯</th>
                                    <th>è¯„è®ºå†…å®¹</th>
                                    <th width="330">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="notifyTableBody"></tbody>
                        </table>
                        <div class="empty-state" id="notifyEmptyState">
                            <div class="empty-state-icon">ğŸ“¬</div>
                            <div class="empty-state-text">æš‚æ— é€šçŸ¥æ•è·</div>
                        </div>
                    </div>
                </div>

                <!-- æ¨æ–‡ç»“æœ -->
                <div class="card">
                    <div class="result-header">
                        <div class="result-count">
                            <div class="card-header-icon" style="background: linear-gradient(135deg, #00ff88, #00cc66);">ğŸ’¬</div>
                            <h3 style="font-size:16px;">æ¨æ–‡æ•è·</h3>
                            <span class="result-count-num" id="tweetCount">0</span>
                        </div>
                        <div class="result-actions">
                            <input type="text" id="tweetFilterInput" class="result-filter" list="tweetFilterOptions" placeholder="ç­›é€‰ @ç”¨æˆ· / å…³é”®è¯" oninput="applyResultFilter('tweet')">
                            <datalist id="tweetFilterOptions"></datalist>
                            <button class="btn-ghost btn-sm" onclick="clearResults('tweet')">ğŸ—‘ï¸ æ¸…ç©º</button>
                            <button class="btn-ghost btn-sm" onclick="clearBlocklist()">â›” æ¸…ç©ºé»‘åå•</button>
                        </div>
                    </div>

                    <div class="table-container resizable">
                        <table>
                            <thead>
                                <tr>
                                    <th width="70">æ—¶é—´</th>
                                    <th width="110">ç”¨æˆ·</th>
                                    <th>è¯„è®ºå†…å®¹</th>
                                    <th width="90">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tweetTableBody"></tbody>
                        </table>
                        <div class="empty-state" id="tweetEmptyState">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div class="empty-state-text">æš‚æ— æ¨æ–‡æ•è·</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const tableBodyIds = { notify: 'notifyTableBody', tweet: 'tweetTableBody' };
        const filterInputIds = { notify: 'notifyFilterInput', tweet: 'tweetFilterInput' };
        const filterOptionIds = { notify: 'notifyFilterOptions', tweet: 'tweetFilterOptions' };
        let notifyReplyTemplates = [];
        let dmMessageTemplates = [];
        const templateEditState = { reply: -1, dm: -1 };

        window.onload = () => fetch('/api/state').then(r=>r.json()).then(d=>{
            document.getElementById('token').value = d.token || '';
            document.getElementById('notifCheckbox').checked = d.notification_monitoring || false;
            document.getElementById('headlessCheckbox').checked = d.headless_mode !== false;
            document.getElementById('delegatedAccount').value = d.delegated_account || '';
            syncTemplatesFromPayload(d);
            renderTasks(d.tasks);
            if(d.is_running) setStatus(true);

            if(d.pending && d.pending.length > 0) {
                d.pending.forEach(item => addRow(item, false));
            }

            refreshFilterOptions('notify');
            refreshFilterOptions('tweet');
            applyResultFilter('notify');
            applyResultFilter('tweet');
        });

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escapeAttr(str) {
            return escapeHtml(str).replace(/`/g, '&#96;');
        }

        function setStatus(run) {
            document.getElementById('startBtn').disabled = run;
            document.getElementById('stopBtn').disabled = !run;
            document.getElementById('token').disabled = run;

            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if(run) {
                dot.classList.add('running');
                text.textContent = 'è¿è¡Œä¸­';
                text.style.color = 'var(--success)';
            } else {
                dot.classList.remove('running');
                text.textContent = 'å·²åœæ­¢';
                text.style.color = 'var(--danger)';
            }
        }

        function renderTasks(t) {
            const div = document.getElementById('taskList');
            if(!t || t.length === 0) {
                div.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-secondary); font-size:13px;">æš‚æ— ç›‘æ§ä»»åŠ¡</div>';
                return;
            }
            div.innerHTML = t.map(x => `
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-url">${x.url.split('status/')[1] || x.url}</div>
                        <div class="task-time">ä¸Šæ¬¡æ£€æŸ¥: ${x.last_check}</div>
                    </div>
                    <button class="task-delete" onclick="delTask('${x.url}')">âœ•</button>
                </div>`).join('');
        }

        function addTask() {
            const u = document.getElementById('newUrl').value;
            if(!u) return;
            fetch('/api/task/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url:u})})
                .then(r=>r.json()).then(d=>{ renderTasks(d.tasks); document.getElementById('newUrl').value=''; });
        }

        function delTask(u) {
            fetch('/api/task/remove', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url:u})})
                .then(r=>r.json()).then(d=>renderTasks(d.tasks));
        }

        function toggle(s) {
            const t = document.getElementById('token').value;
            if(s && !t) return alert('è¯·å…ˆè¾“å…¥ Token');
            fetch(s?'/api/start':'/api/stop', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:t})})
                .then(r=>r.json()).then(d => { if(d.status==='ok') setStatus(s); });
        }

        function toggleNotificationMonitoring() {
            const enabled = document.getElementById('notifCheckbox').checked;
            fetch('/api/toggle_notification', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({enabled:enabled})})
                .then(r=>r.json());
        }

        function toggleHeadlessMode() {
            const enabled = document.getElementById('headlessCheckbox').checked;
            fetch('/api/toggle_headless', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({enabled:enabled})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        const modeText = enabled ? 'æ— å¤´æ¨¡å¼' : 'æœ‰å¤´æ¨¡å¼(è°ƒè¯•)';
                        alert(`ğŸ–¥ï¸ å·²åˆ‡æ¢ä¸º${modeText}\nâš ï¸ éœ€è¦é‡å¯ç›‘æ§æ‰èƒ½ç”Ÿæ•ˆ`);
                    }
                });
        }

        function saveDelegatedAccount() {
            const account = document.getElementById('delegatedAccount').value.trim();
            fetch('/api/set_delegated_account', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({account:account})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        alert(account ? `âœ… å·²è®¾ç½®å§”æ´¾è´¦æˆ·: ${account}` : 'âœ… å·²æ¸…é™¤å§”æ´¾è´¦æˆ·');
                    }
                });
        }

        function getTemplateArray(type) {
            return type === 'reply' ? notifyReplyTemplates : dmMessageTemplates;
        }

        function getTemplateTypeName(type) {
            return type === 'reply' ? 'è¯„è®ºå›å¤' : 'ç§ä¿¡';
        }

        function getTemplateInput(type) {
            return document.getElementById(type === 'reply' ? 'replyTemplateInput' : 'dmTemplateInput');
        }

        function getTemplateSubmitBtn(type) {
            return document.getElementById(type === 'reply' ? 'replyTemplateSubmitBtn' : 'dmTemplateSubmitBtn');
        }

        function getTemplateCancelBtn(type) {
            return document.getElementById(type === 'reply' ? 'replyTemplateCancelBtn' : 'dmTemplateCancelBtn');
        }

        function applyTemplateEditUi(type) {
            const isEdit = templateEditState[type] >= 0;
            const submitBtn = getTemplateSubmitBtn(type);
            const cancelBtn = getTemplateCancelBtn(type);
            if(submitBtn) {
                submitBtn.textContent = isEdit
                    ? 'ğŸ’¾ ä¿å­˜ä¿®æ”¹'
                    : (type === 'reply' ? 'â• æ·»åŠ è¯„è®ºæ–‡æ¡ˆ' : 'â• æ·»åŠ ç§ä¿¡æ–‡æ¡ˆ');
            }
            if(cancelBtn) {
                cancelBtn.style.display = isEdit ? 'inline-flex' : 'none';
            }
        }

        function startTemplateEdit(type, index, content) {
            templateEditState[type] = index;
            const input = getTemplateInput(type);
            if(input) {
                input.value = content || '';
                input.focus();
                try {
                    if(typeof input.setSelectionRange === 'function') {
                        input.setSelectionRange(input.value.length, input.value.length);
                    }
                } catch (_) {}
            }
            applyTemplateEditUi(type);
        }

        function cancelTemplateEdit(type) {
            templateEditState[type] = -1;
            const input = getTemplateInput(type);
            if(input) input.value = '';
            applyTemplateEditUi(type);
        }

        function syncTemplatesFromPayload(payload) {
            notifyReplyTemplates = Array.isArray(payload.notify_reply_templates) ? payload.notify_reply_templates.slice() : [];
            dmMessageTemplates = Array.isArray(payload.dm_message_templates) ? payload.dm_message_templates.slice() : [];
            if(templateEditState.reply >= notifyReplyTemplates.length) templateEditState.reply = -1;
            if(templateEditState.dm >= dmMessageTemplates.length) templateEditState.dm = -1;
            renderTemplateManager();
        }

        function renderTemplateManager() {
            renderTemplateList('reply', 'replyTemplateList');
            renderTemplateList('dm', 'dmTemplateList');
            applyTemplateEditUi('reply');
            applyTemplateEditUi('dm');
            refreshNotifyTemplateSelects();
        }

        function renderTemplateList(type, listId) {
            const list = document.getElementById(listId);
            const templates = getTemplateArray(type);
            if(!list) return;
            if(!templates.length) {
                list.innerHTML = '<li><div class="template-text" style="color:var(--text-secondary);">æš‚æ— æ¨¡æ¿</div></li>';
                return;
            }
            list.innerHTML = templates.map((tpl, idx) => `
                <li>
                    <div class="template-text">${escapeHtml(tpl)}</div>
                    <div class="template-actions">
                        <button class="btn-ghost btn-sm" onclick="editTemplate('${type}', ${idx})">âœï¸ ä¿®æ”¹</button>
                        <button class="btn-danger btn-sm" onclick="deleteTemplate('${type}', ${idx})">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </li>
            `).join('');
        }

        function handleTemplateApiResponse(d, failPrefix) {
            if(!d || d.status !== 'ok') {
                alert(`${failPrefix}: ${(d && d.msg) ? d.msg : 'æœªçŸ¥é”™è¯¯'}`);
                return false;
            }
            syncTemplatesFromPayload(d);
            return true;
        }

        function submitTemplate(type) {
            const input = getTemplateInput(type);
            if(!input) return;
            const content = (input.value || '').trim();
            if(!content) {
                alert(`è¯·è¾“å…¥${getTemplateTypeName(type)}æ–‡æ¡ˆ`);
                return;
            }

            const editingIndex = templateEditState[type];
            if(editingIndex >= 0) {
                fetch('/api/template/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type, index: editingIndex, content})
                }).then(r => r.json()).then(d => {
                    if(handleTemplateApiResponse(d, 'ä¿®æ”¹æ¨¡æ¿å¤±è´¥')) {
                        cancelTemplateEdit(type);
                    }
                }).catch(() => {
                    alert('ç½‘ç»œå¼‚å¸¸ï¼Œä¿®æ”¹æ¨¡æ¿å¤±è´¥');
                });
                return;
            }

            fetch('/api/template/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type, content})
            }).then(r => r.json()).then(d => {
                if(handleTemplateApiResponse(d, 'æ·»åŠ æ¨¡æ¿å¤±è´¥')) {
                    input.value = '';
                    applyTemplateEditUi(type);
                }
            }).catch(() => {
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œæ·»åŠ æ¨¡æ¿å¤±è´¥');
            });
        }

        function editTemplate(type, index) {
            const templates = getTemplateArray(type);
            if(index < 0 || index >= templates.length) return;
            startTemplateEdit(type, index, templates[index]);
        }

        function deleteTemplate(type, index) {
            const templates = getTemplateArray(type);
            if(index < 0 || index >= templates.length) return;
            if(!confirm(`ç¡®å®šåˆ é™¤è¿™æ¡${getTemplateTypeName(type)}æ–‡æ¡ˆå—ï¼Ÿ`)) return;
            fetch('/api/template/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type, index})
            }).then(r => r.json()).then(d => {
                if(handleTemplateApiResponse(d, 'åˆ é™¤æ¨¡æ¿å¤±è´¥')) {
                    cancelTemplateEdit(type);
                }
            }).catch(() => {
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œåˆ é™¤æ¨¡æ¿å¤±è´¥');
            });
        }

        function buildTemplateOptionHtml(templates) {
            return templates.map(t => {
                const optionValue = escapeAttr(t);
                const optionText = escapeHtml(String(t).replace(/\s+/g, ' ').trim());
                return `<option value="${optionValue}">${optionText}</option>`;
            }).join('');
        }

        function updateSelectOptions(select, templates, placeholderText) {
            if(!select) return;
            const selectedValue = select.value || '';
            const optionsHtml = buildTemplateOptionHtml(templates);
            select.innerHTML = `<option value="">${escapeHtml(placeholderText)}</option>${optionsHtml}`;
            if(selectedValue && templates.includes(selectedValue)) {
                select.value = selectedValue;
            }
        }

        function refreshNotifyTemplateSelects() {
            const rows = getTableRows('notify');
            rows.forEach(row => {
                updateSelectOptions(row.querySelector('.reply-template-select'), notifyReplyTemplates, 'é€‰æ‹©å›å¤å†…å®¹...');
                updateSelectOptions(row.querySelector('.dm-template-select'), dmMessageTemplates, 'é€‰æ‹©ç§ä¿¡å†…å®¹...');
            });
        }

        function markDone(key, btn) {
            const row = btn.closest('tr');
            const handle = row ? (row.getAttribute('data-handle') || '') : '';
            if(row) row.style.opacity = '0.3';

            fetch('/api/mark_done', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({key:key, handle:handle})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        setTimeout(() => {
                            if(row) row.remove();
                            refreshFilterOptions('notify');
                            refreshFilterOptions('tweet');
                            updateResultCount();
                        }, 300);
                    }
                });
        }

        function markDoneFromButton(btn) {
            const row = btn.closest('tr');
            const key = row ? (row.getAttribute('data-key') || '') : '';
            if(!key) return;
            markDone(key, btn);
        }

        function sendNotifyReply(btn) {
            const row = btn.closest('tr');
            const key = row ? (row.getAttribute('data-key') || '') : '';
            const handle = row ? (row.getAttribute('data-handle') || '') : '';
            const replySelect = row ? row.querySelector('.reply-template-select') : null;
            const dmSelect = row ? row.querySelector('.dm-template-select') : null;
            const message = replySelect ? (replySelect.value || '').trim() : '';
            const dmMessage = dmSelect ? (dmSelect.value || '').trim() : '';
            if(!key || !message) {
                alert('è¯·å…ˆé€‰æ‹©å›å¤å†…å®¹');
                return;
            }
            if(!dmMessage) {
                alert('è¯·å…ˆé€‰æ‹©ç§ä¿¡å†…å®¹');
                return;
            }

            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = 'å‘é€ä¸­...';

            fetch('/api/notify_reply', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({key:key, message:message, dm_message:dmMessage})
            }).then(r=>r.json()).then(d => {
                if(d.status === 'ok') {
                    alert(`âœ… å·²å›å¤ ${handle || ''}`);
                } else {
                    alert(`å›å¤å¤±è´¥: ${d.msg || 'æœªçŸ¥é”™è¯¯'}`);
                }
            }).catch(() => {
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œå›å¤å¤±è´¥');
            }).finally(() => {
                btn.disabled = false;
                btn.textContent = oldText;
            });
        }

        function clearResults(type) {
            const typeText = type === 'notify' ? 'é€šçŸ¥' : 'æ¨æ–‡';
            if(!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${typeText}æ•è·ç»“æœå—ï¼Ÿ`)) return;
            fetch('/api/clear_results', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type: type})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        if(type === 'notify') {
                            document.getElementById('notifyTableBody').innerHTML = '';
                        } else {
                            document.getElementById('tweetTableBody').innerHTML = '';
                        }
                        refreshFilterOptions(type);
                        applyResultFilter(type);
                    }
                });
        }

        function clearBlocklist() {
            if(!confirm('ç¡®å®šè¦æ¸…ç©ºé»‘åå•å—ï¼Ÿ')) return;
            fetch('/api/clear_blocklist', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({})})
                .then(r=>r.json()).then(d => {
                    if(d.status === 'ok') {
                        alert('âœ… å·²æ¸…ç©ºé»‘åå•');
                    }
                });
        }

        function getTableRows(type) {
            return Array.from(document.getElementById(tableBodyIds[type]).children);
        }

        function refreshFilterOptions(type) {
            const datalist = document.getElementById(filterOptionIds[type]);
            const input = document.getElementById(filterInputIds[type]);
            if(!datalist || !input) return;

            const values = new Set();
            getTableRows(type).forEach(row => {
                const handle = (row.getAttribute('data-handle') || '').trim();
                if(handle) values.add(handle);
            });
            if(input.value.trim()) values.add(input.value.trim());

            datalist.innerHTML = '';
            Array.from(values).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN')).forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                datalist.appendChild(option);
            });
        }

        function applyResultFilter(type) {
            const input = document.getElementById(filterInputIds[type]);
            if(!input) return;

            const query = input.value.trim().toLowerCase();
            getTableRows(type).forEach(row => {
                const handle = (row.getAttribute('data-handle') || '').toLowerCase();
                const content = (row.querySelector('.content-cell')?.textContent || '').toLowerCase();
                const matched = !query || handle.includes(query) || content.includes(query);
                row.style.display = matched ? '' : 'none';
            });
            updateResultCount();
        }

        function updateResultCount() {
            const notifyRows = getTableRows('notify');
            const tweetRows = getTableRows('tweet');
            const notifyVisibleCount = notifyRows.filter(row => row.style.display !== 'none').length;
            const tweetVisibleCount = tweetRows.filter(row => row.style.display !== 'none').length;
            const notifyFilterActive = document.getElementById(filterInputIds.notify).value.trim() !== '';
            const tweetFilterActive = document.getElementById(filterInputIds.tweet).value.trim() !== '';

            document.getElementById('notifyCount').textContent = notifyFilterActive ? `${notifyVisibleCount}/${notifyRows.length}` : `${notifyRows.length}`;
            document.getElementById('tweetCount').textContent = tweetFilterActive ? `${tweetVisibleCount}/${tweetRows.length}` : `${tweetRows.length}`;
            document.getElementById('notifyEmptyState').style.display = notifyVisibleCount > 0 ? 'none' : 'block';
            document.getElementById('tweetEmptyState').style.display = tweetVisibleCount > 0 ? 'none' : 'block';
        }

        function addRow(i, animate=true) {
            if(document.querySelector(`tr[data-key="${i.key}"]`)) return;

            const tr = document.createElement('tr');
            if(animate) tr.className = 'row-enter';
            tr.setAttribute('data-handle', i.handle);
            tr.setAttribute('data-key', i.key);

            const isNotify = i.source === 'é€šçŸ¥é¡µé¢';
            const safeHandle = escapeHtml(i.handle || '');
            const handlePath = escapeAttr((i.handle || '').replace('@', ''));
            const userCellHtml = isNotify
                ? `<div class="user-info-cell">
                        <a class="user-link" href="https://x.com/${handlePath}/with_replies" target="_blank">${safeHandle}</a>
                   </div>`
                : `<a class="user-link" href="https://x.com/${handlePath}/with_replies" target="_blank">${safeHandle}</a>`;
            const replyOptions = buildTemplateOptionHtml(notifyReplyTemplates);
            const dmOptions = buildTemplateOptionHtml(dmMessageTemplates);
            const actionHtml = isNotify
                ? `<div class="action-stack">
                        <select class="reply-template-select">
                            <option value="">é€‰æ‹©å›å¤å†…å®¹...</option>
                            ${replyOptions}
                        </select>
                        <select class="dm-template-select">
                            <option value="">é€‰æ‹©ç§ä¿¡å†…å®¹...</option>
                            ${dmOptions}
                        </select>
                        <div class="action-btn-row">
                            <button class="btn-reply btn-sm" onclick="sendNotifyReply(this)">â†© å›å¤</button>
                            <button class="btn-primary btn-sm" onclick="markDoneFromButton(this)">âœ… å·²å¤„ç†</button>
                        </div>
                   </div>`
                : `<button class="btn-primary btn-sm" onclick="markDoneFromButton(this)">âœ… å·²å¤„ç†</button>`;

            tr.innerHTML = `
                <td style="color:var(--text-secondary)">${escapeHtml(i.time || '')}</td>
                <td>${userCellHtml}</td>
                <td class="content-cell">${escapeHtml(i.content || '')}</td>
                <td>${actionHtml}</td>
            `;

            if(isNotify) {
                document.getElementById('notifyTableBody').prepend(tr);
            } else {
                document.getElementById('tweetTableBody').prepend(tr);
            }
            const type = isNotify ? 'notify' : 'tweet';
            refreshFilterOptions(type);
            applyResultFilter(type);
        }

        setInterval(() => {
            fetch('/api/updates').then(r=>r.json()).then(d => {
                d.new_items.forEach(i => addRow(i, true));
                if(d.tasks) renderTasks(d.tasks);
            });
        }, 1000);
    </script>
</body>
</html>

# ğŸ“¦ æ•°æ®æŒä¹…åŒ–è¯´æ˜

## æ•°æ®å­˜å‚¨ä½ç½®

æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ `/app/data/` ç›®å½•ï¼ˆDockerï¼‰æˆ–é¡¹ç›®æ ¹ç›®å½•çš„ `data/` æ–‡ä»¶å¤¹ä¸­ã€‚

### æ•°æ®æ–‡ä»¶ç»“æ„

```
./data/
â”œâ”€â”€ spider_state.json       # ä¸»çŠ¶æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ token              # Auth Token
â”‚   â”œâ”€â”€ tasks              # ç›‘æ§ä»»åŠ¡åˆ—è¡¨
â”‚   â”œâ”€â”€ pending            # å¾…å¤„ç†ç»“æœåˆ—è¡¨
â”‚   â”œâ”€â”€ history_ids        # å»é‡ç¼“å­˜ï¼ˆé‡è¦ï¼ï¼‰
â”‚   â”œâ”€â”€ notification_monitoring  # é€šçŸ¥ç›‘æ§çŠ¶æ€
â”‚   â””â”€â”€ is_running         # è¿è¡ŒçŠ¶æ€
â”‚
â””â”€â”€ processed_users.json    # å·²å¤„ç†ç”¨æˆ·é»‘åå•
```

---

## æ•°æ®æŒä¹…åŒ–æœºåˆ¶

### 1. è‡ªåŠ¨ä¿å­˜æ—¶æœº

âœ… **å®æ—¶ä¿å­˜**ï¼š
- æ¯æ¬¡æŠ“å–åˆ°æ–°å†…å®¹åç«‹å³ä¿å­˜
- æ¯æ¬¡æ ‡è®°ç”¨æˆ·"å·²ç§ä¿¡"åç«‹å³ä¿å­˜
- åœæ­¢ç›‘æ§æ—¶ä¿å­˜

âœ… **å‘¨æœŸæ€§ä¿å­˜**ï¼ˆ60ç§’ï¼‰ï¼š
- ç›‘æ§è¿è¡ŒæœŸé—´æ¯60ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
- ç¡®ä¿é•¿æ—¶é—´è¿è¡Œä¸ä¸¢å¤±æ•°æ®

âœ… **é€€å‡ºæ—¶ä¿å­˜**ï¼š
- æ­£å¸¸åœæ­¢å¼•æ“æ—¶ä¿å­˜
- ç¨‹åºé€€å‡ºæ—¶ä¿å­˜ï¼ˆCtrl+Cï¼‰
- å¼‚å¸¸é€€å‡ºæ—¶åœ¨ finally å—ä¸­ä¿å­˜

### 2. æ•°æ®åŠ è½½

ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æ‰€æœ‰æŒä¹…åŒ–æ•°æ®ï¼š
```
âœ… å·²æ¢å¤ 1234 æ¡å†å²å»é‡è®°å½•
âœ… çŠ¶æ€åŠ è½½æˆåŠŸ:
   - Token: å·²é…ç½®
   - ç›‘æ§ä»»åŠ¡: 3 ä¸ª
   - å¾…å¤„ç†: 12 æ¡
   - å†å²è®°å½•: 1234 æ¡
   - é€šçŸ¥ç›‘æ§: å¯ç”¨
âœ… å·²æ¢å¤ 56 ä¸ªå·²å¤„ç†ç”¨æˆ·
```

---

## Docker éƒ¨ç½²æ•°æ®æŒä¹…åŒ–

### docker-compose.yml é…ç½®

```yaml
volumes:
  - ./data:/app/data  # æ•°æ®å·æ˜ å°„
```

### ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±

1. **å®¹å™¨é‡å¯**ï¼šæ•°æ®ä¿ç•™åœ¨ `./data` ç›®å½•
2. **å®¹å™¨åˆ é™¤**ï¼šæ•°æ®ä»åœ¨å®¿ä¸»æœº `./data` ç›®å½•
3. **å®¹å™¨æ›´æ–°**ï¼šä½¿ç”¨ `docker-compose down && docker-compose up -d`

### æ•°æ®å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®
cp -r ./data ./data_backup_$(date +%Y%m%d)

# æ¢å¤æ•°æ®
cp -r ./data_backup_20260127/* ./data/
```

---

## é Docker éƒ¨ç½²

### ç›´æ¥è¿è¡Œ Python

```bash
python3 app.py
```

æ•°æ®ä¿å­˜åœ¨ï¼š
- **Linux/Mac**: `./data/`
- **Windows**: `.\\data\\`

### æ•°æ®æ–‡ä»¶æƒé™

```bash
# ç¡®ä¿æ•°æ®ç›®å½•å¯å†™
chmod 755 data/
chmod 644 data/*.json
```

---

## éªŒè¯æ•°æ®æŒä¹…åŒ–

### 1. å¯åŠ¨ç¨‹åºå¹¶æ·»åŠ æ•°æ®

```bash
# å¯åŠ¨ç¨‹åº
docker-compose up -d

# æˆ–ç›´æ¥è¿è¡Œ
python3 app.py
```

### 2. æ£€æŸ¥æ•°æ®æ–‡ä»¶

```bash
# æŸ¥çœ‹çŠ¶æ€æ–‡ä»¶
cat data/spider_state.json

# æŸ¥çœ‹å·²å¤„ç†ç”¨æˆ·
cat data/processed_users.json
```

### 3. é‡å¯æµ‹è¯•

```bash
# Docker é‡å¯
docker-compose restart

# æˆ–ç›´æ¥é‡å¯ Python
# Ctrl+C åœæ­¢ï¼Œç„¶åé‡æ–° python3 app.py
```

### 4. éªŒè¯æ•°æ®æ¢å¤

æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
âœ… å·²æ¢å¤ XXX æ¡å†å²å»é‡è®°å½•
âœ… çŠ¶æ€åŠ è½½æˆåŠŸ
```

---

## å¸¸è§é—®é¢˜

### Q1: é‡å¯åæ•°æ®ä¸¢å¤±ï¼Ÿ

**åŸå› **ï¼š
- Docker å·æ˜ å°„é…ç½®é”™è¯¯
- æ•°æ®ç›®å½•æƒé™é—®é¢˜
- ç¨‹åºå¼‚å¸¸é€€å‡ºæœªä¿å­˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥å·æ˜ å°„
docker inspect x-monitor | grep Mounts -A 10

# 2. æ£€æŸ¥æ•°æ®æ–‡ä»¶
ls -la data/

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### Q2: history_ids è¿‡å¤§ï¼Ÿ

**åŸå› **ï¼š
é•¿æ—¶é—´è¿è¡Œï¼Œå»é‡ç¼“å­˜ç§¯ç´¯è¿‡å¤š

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ³•1ï¼šæ¸…ç©ºå†å²è®°å½•ï¼ˆä¼šé‡æ–°æŠ“å–å·²å¤„ç†çš„å†…å®¹ï¼‰
echo '[]' > data/spider_state.json

# æ–¹æ³•2ï¼šå®šæœŸå¤‡ä»½å¹¶æ¸…ç†ï¼ˆæ¨èï¼‰
# å¤‡ä»½å½“å‰çŠ¶æ€
cp data/spider_state.json data/spider_state_backup.json

# ç¼–è¾‘æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘çš„ history_ids
# æˆ–ä½¿ç”¨ Python è„šæœ¬æ¸…ç†
```

### Q3: æ•°æ®æ–‡ä»¶æŸåï¼Ÿ

**ç—‡çŠ¶**ï¼š
```
åŠ è½½çŠ¶æ€å¤±è´¥: Expecting value: line 1 column 1 (char 0)
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ¢å¤å¤‡ä»½
cp data_backup/spider_state.json data/

# æˆ–é‡æ–°åˆå§‹åŒ–
rm data/spider_state.json
# é‡å¯ç¨‹åºä¼šè‡ªåŠ¨åˆ›å»ºæ–°æ–‡ä»¶
```

---

## æ€§èƒ½ä¼˜åŒ–

### æ§åˆ¶ history_ids å¤§å°

å»ºè®®å®šæœŸæ¸…ç†ï¼ˆæ¯å‘¨æˆ–æ¯æœˆï¼‰ï¼š

```python
# æ¸…ç†è„šæœ¬ cleanup.py
import json

# åªä¿ç•™æœ€è¿‘7å¤©çš„å†å²è®°å½•
max_history = 10000

with open('data/spider_state.json', 'r') as f:
    state = json.load(f)

if len(state['history_ids']) > max_history:
    state['history_ids'] = state['history_ids'][-max_history:]

with open('data/spider_state.json', 'w') as f:
    json.dump(state, f, indent=4)

print(f"æ¸…ç†å®Œæˆï¼Œä¿ç•™ {len(state['history_ids'])} æ¡è®°å½•")
```

---

## ç›‘æ§æ•°æ®å¢é•¿

```bash
# æŸ¥çœ‹æ•°æ®æ–‡ä»¶å¤§å°
du -h data/

# ç›‘æ§æ–‡ä»¶å˜åŒ–
watch -n 5 'ls -lh data/'
```

---

## æ€»ç»“

âœ… **å®Œæ•´æŒä¹…åŒ–**ï¼š
- Tokenã€ä»»åŠ¡ã€å¾…å¤„ç†ç»“æœ
- **å†å²å»é‡è®°å½•ï¼ˆæ–°å¢ï¼‰**
- å·²å¤„ç†ç”¨æˆ·é»‘åå•
- é€šçŸ¥ç›‘æ§çŠ¶æ€

âœ… **å¤šé‡ä¿æŠ¤**ï¼š
- å®æ—¶ä¿å­˜
- å‘¨æœŸæ€§ä¿å­˜ï¼ˆ60ç§’ï¼‰
- é€€å‡ºæ—¶ä¿å­˜

âœ… **Docker å‹å¥½**ï¼š
- å·æ˜ å°„é…ç½®
- å®¹å™¨é‡å¯æ•°æ®ä¿ç•™
- æ˜“äºå¤‡ä»½å’Œè¿ç§»

---

**ç°åœ¨é‡å¯åº”ç”¨åï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¼šå®Œæ•´æ¢å¤ï¼** ğŸ‰
